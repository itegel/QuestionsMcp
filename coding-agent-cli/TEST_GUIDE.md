# 测试指南 - 多 Agent 协作和自我反思

## 🎯 测试方式

### 方式一：交互式测试（推荐）

```bash
cd /Users/baoxiangxin/Programming/github/QuestionsMcp/coding-agent-cli
java -jar target/coding-agent-cli-1.0.0-jar-with-dependencies.jar chat
```

然后在交互界面中输入以下命令：

---

## 📝 测试场景

### 场景 1：测试 Multi-Agent 协作系统

**目标**：让系统自动分解任务并协调多个 Agent 完成复杂任务

#### 步骤：

1. 启动 chat
```bash
java -jar target/coding-agent-cli-1.0.0-jar-with-dependencies.jar chat
```

2. 输入 `collaborate` 命令
```
collaborate
```

3. 或者输入复杂任务（会自动触发协作）
```
帮我创建一个完整的用户管理系统，包括实体类、服务层和数据访问层
```

**预期输出**：
```
╔════════════════════════════════════════════╗
║  多 Agent 协作系统 - Multi-Agent Coordinator  ║
╚════════════════════════════════════════════╝

📋 任务分解:
  子任务数：3
  执行策略：generation

🚀 开始执行任务计划...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
步骤 1/3
  任务：理解需求
  执行 Agent: analyzer
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[CodeAnalyzer 执行过程...]

✅ 步骤 1 完成

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
步骤 2/3
  任务：生成代码
  执行 Agent: generator
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[CodeGenerator 执行过程...]

✅ 步骤 2 完成

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
步骤 3/3
  任务：代码审查
  执行 Agent: reflecting
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[SelfReflectingAgent 执行过程...]

✅ 步骤 3 完成

═══════════════════════════════════════════
✅ 所有步骤执行完毕
═══════════════════════════════════════════

╔════════════════════════════════════════════╗
║         任务执行总结报告                   ║
╚════════════════════════════════════════════╝

📋 执行策略：generation
📊 执行步骤：3 步

📝 详细结果:
[各步骤的详细结果...]
```

---

### 场景 2：测试 Self-Reflecting Agent

**目标**：测试 Agent 的自我反思和改进能力

#### 步骤：

1. 启动 chat
```bash
java -jar target/coding-agent-cli-1.0.0-jar-with-dependencies.jar chat
```

2. 输入需要深度分析的任务
```
帮我深入分析 src/main/java/com/codingagent/agent/react/ReActAgent.java 的代码质量，并给出改进建议
```

**预期输出**：
```
╔════════════════════════════════════════════╗
║  自我反思 Agent - Self-Reflective Agent      ║
╚════════════════════════════════════════════╝

🚀 第一阶段：执行任务
任务：帮我深入分析...

[ReAct 执行过程...]

📊 初步结果：[初步分析结果]...

🤔 第二阶段：自我反思

🤔 开始自我反思...
✅ 反思完成
   质量评分：8/10
   改进建议：3 条

=== 反思结果 ===
任务 ID: xxx-xxx-xxx
质量评分：8/10

✅ 优势:
  - 代码结构清晰
  - 使用了设计模式
  - 错误处理完善

⚠️  不足:
  - 缺少单元测试
  - 文档注释不够详细
  - 配置参数硬编码

💡 改进建议:
  - 添加单元测试覆盖
  - 补充 JavaDoc 文档
  - 使用配置类管理参数

📚 经验教训:
[总结...]

✅ 结果质量良好，无需重试
```

---

### 场景 3：查看可用 Agent

**目标**：查看系统中所有可用的 Agent

#### 步骤：

1. 启动 chat
```bash
java -jar target/coding-agent-cli-1.0.0-jar-with-dependencies.jar chat
```

2. 输入 `agents` 命令
```
agents
```

**预期输出**：
```
=== Agent 状态 ===
  analyzer: CodeAnalyzer - 代码分析专家
  generator: CodeGenerator - 代码生成专家
  react: ReActAgent - 智能推理 Agent
  reflecting: SelfReflectingAgent - 带自我反思的智能 Agent
```

---

### 场景 4：测试不同任务类型的自动路由

**目标**：测试系统根据任务类型自动选择执行策略

#### 测试用例：

1. **分析类任务**（触发 analysis 策略）
```
分析 src/main/java/com/codingagent/tool/ToolManager.java 的架构设计
```

2. **生成类任务**（触发 generation 策略，多步骤）
```
生成一个工具类，包含字符串处理和日期处理方法
```

3. **重构类任务**（触发 refactoring 策略，多步骤）
```
重构这个类，使用设计模式优化代码结构
```

4. **调试类任务**（触发 debugging 策略，多步骤）
```
帮我找出这个文件中的潜在 bug 并修复
```

---

## 🔍 调试技巧

### 1. 查看详细执行日志

在测试时，系统会输出详细的执行过程：

```
📝 LLM 原始输出:
---
[LLM 的完整输出]
---

🔍 解析结果:
  Thought: ✓
  Action: ✓
  FinalAnswer: ✗
```

### 2. 观察 Agent 选择过程

```
🤖 意图识别:
   类型：分析
   置信度：高
   理由：用户明确使用了动词'分析'...

🤖 已选择 CodeAnalyzer 来处理你的请求
```

### 3. 查看反思历史

在代码中可以通过 `ReflectionHistory.getInstance().getAllReflections()` 查看所有反思记录。

---

## 📊 测试检查清单

### Multi-Agent 协作

- [ ] 任务能否正确分解为子任务
- [ ] 是否根据任务类型选择正确的策略
- [ ] 多个 Agent 能否正确协同工作
- [ ] 上下文信息是否在 Agent 间正确传递
- [ ] 最终结果是否综合了所有步骤的输出

### Self-Reflecting Agent

- [ ] 是否对执行结果进行了反思
- [ ] 反思结果是否包含质量评分
- [ ] 是否生成了优势、不足和改进建议
- [ ] 低质量结果是否会触发重新执行
- [ ] 反思历史是否正确保存

### 系统稳定性

- [ ] 长时间运行是否稳定
- [ ] 错误处理是否完善
- [ ] 资源使用是否合理
- [ ] 会话管理是否正常

---

## 🐛 常见问题

### Q1: Agent 执行失败怎么办？

**A**: 查看错误信息，检查：
- 文件路径是否正确
- 工具参数格式是否正确
- LLM API 配置是否正确

### Q2: 反思结果质量不高？

**A**: 这是正常的，因为：
- LLM 的输出有随机性
- 可能需要多次迭代
- 可以调整 prompt 提高质量

### Q3: 多 Agent 协作很慢？

**A**: 这是预期行为，因为：
- 每个子任务都要调用 LLM
- 复杂任务需要多个步骤
- 可以通过减少子任务数量优化

---

## 📈 性能优化建议

1. **减少不必要的反思**
   - 简单任务不需要反思
   - 可以设置质量阈值

2. **优化任务分解**
   - 避免过度分解
   - 合并相关的子任务

3. **缓存反思结果**
   - 相似任务可以复用反思
   - 使用 ReflectionHistory 查询

---

## 🎓 学习重点

通过测试，重点理解：

1. **自我反思机制**
   - 如何评估工作质量
   - 如何生成改进建议
   - 如何实现持续优化

2. **多 Agent 协作**
   - 任务分解策略
   - Agent 间通信机制
   - 结果综合方法

3. **系统设计**
   - 如何设计可扩展的 Agent 架构
   - 如何管理 Agent 生命周期
   - 如何处理并发和状态

---

祝测试顺利！🚀
